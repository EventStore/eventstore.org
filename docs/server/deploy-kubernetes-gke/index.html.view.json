{"conceptual":"\n<p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"7\" sourceendlinenumber=\"9\">This guide is to show how to use <a href=\"https://github.com/EventStore/EventStore.Charts\" data-raw-source=\"[the official Event Store Helm Chart](https://github.com/EventStore/EventStore.Charts)\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"7\" sourceendlinenumber=\"7\">the official Event Store Helm Chart</a> to\ninteractively deploy an Event Store Cluster in Kubernetes Google Cloud\nGKE service.</p>\n<h2 id=\"prerequisites\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"11\" sourceendlinenumber=\"11\">Prerequisites</h2>\n<p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"13\" sourceendlinenumber=\"13\">Install the following utilities in your development machine.</p>\n<ul sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"15\" sourceendlinenumber=\"17\">\n<li sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"15\" sourceendlinenumber=\"15\"><a href=\"https://kubernetes.io/docs/tasks/tools/install-kubectl\" data-raw-source=\"[Kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl)\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"15\" sourceendlinenumber=\"15\">Kubectl</a></li>\n<li sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"16\" sourceendlinenumber=\"16\"><a href=\"https://github.com/helm/helm/releases\" data-raw-source=\"[Helm](https://github.com/helm/helm/releases)\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"16\" sourceendlinenumber=\"16\">Helm</a></li>\n<li sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"17\" sourceendlinenumber=\"17\"><a href=\"https://cloud.google.com/sdk/install\" data-raw-source=\"[Google Cloud SDK](https://cloud.google.com/sdk/install)\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"17\" sourceendlinenumber=\"17\">Google Cloud SDK</a></li>\n</ul>\n<h2 id=\"configuration-steps\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"19\" sourceendlinenumber=\"19\">Configuration steps</h2>\n<p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"21\" sourceendlinenumber=\"21\">Login in your Google Cloud account using the gcloud cli, this prompts you to login using any browser and copy/paste a key back in to the cli:</p>\n<pre sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"23\" sourceendlinenumber=\"25\"><code class=\"lang-shell\">gcloud auth login --no-launch-browser\n</code></pre><p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"27\" sourceendlinenumber=\"27\">Set the <a href=\"https://cloud.google.com/compute/docs/regions-zones/\" data-raw-source=\"[region](https://cloud.google.com/compute/docs/regions-zones/)\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"27\" sourceendlinenumber=\"27\">region</a>, and the project id from above:</p>\n<pre sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"29\" sourceendlinenumber=\"32\"><code class=\"lang-shell\">gcloud config set compute/region &lt;regionname&gt;\ngcloud config set project &lt;projectid&gt;\n</code></pre><p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"34\" sourceendlinenumber=\"34\">Enable the Kubernetes Engine API for your project, by visiting the <em><a href=\"https://console.cloud.google.com/apis/library/container.googleapis.com?project={project-id}\" data-raw-source=\"&lt;https://console.cloud.google.com/apis/library/container.googleapis.com?project={project-id}&gt;\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"34\" sourceendlinenumber=\"34\">https://console.cloud.google.com/apis/library/container.googleapis.com?project={project-id}</a></em> page.</p>\n<p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"36\" sourceendlinenumber=\"36\">Create a Kubernetes Cluster in your account, the following command does not specify the number of nodes and uses the default of 3:.</p>\n<pre sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"38\" sourceendlinenumber=\"40\"><code class=\"lang-shell\">gcloud container clusters create &lt;clustername&gt; --zone &lt;zonename&gt;\n</code></pre><p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"42\" sourceendlinenumber=\"42\">We recommend kubectl for managing resources in the Kubernetes cluster. Set the current context for kubectl and merge it with any existing configuration in your existing config file:</p>\n<pre sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"44\" sourceendlinenumber=\"46\"><code class=\"lang-shell\">gcloud beta container clusters get-credentials &lt;clustername&gt; --zone &lt;zonename&gt; --project &lt;projectid&gt;\n</code></pre><p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"48\" sourceendlinenumber=\"48\">On the server side Helm relies on a service account called Tiller, and you need to configure this account for <a href=\"https://kubernetes.io/docs/reference/access-authn-authz/rbac/\" data-raw-source=\"[Role Base Access](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"48\" sourceendlinenumber=\"48\">Role Base Access</a> as Google Cloud GKE enables it by default. To configure RBAC follow <a href=\"https://helm.sh/docs/using_helm/#tiller-and-role-based-access-control\" data-raw-source=\"[these instructions](https://helm.sh/docs/using_helm/#tiller-and-role-based-access-control)\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"48\" sourceendlinenumber=\"48\">these instructions</a>. In Summary you need to create a special deployment with the Tiller user settings before running the <code>helm init</code> command.</p>\n<p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"50\" sourceendlinenumber=\"50\">You can then check if the &#39;tiller-deploy-xxxx&#39; pod is running</p>\n<pre sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"52\" sourceendlinenumber=\"54\"><code class=\"lang-shell\">kubectl -n kube-system get pod\n</code></pre><h2 id=\"deploy-event-store-cluster-with-helm\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"56\" sourceendlinenumber=\"56\">Deploy Event Store Cluster with Helm</h2>\n<p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"58\" sourceendlinenumber=\"58\">It is possible to specify a lot of options to customise your Event Store deployment. The setting used in this guide is &quot;Persistent Volume&quot;, that allows you to deploy a <a href=\"https://kubernetes.io/docs/concepts/storage/persistent-volumes/\" data-raw-source=\"[Persistent Volume Claim](https://kubernetes.io/docs/concepts/storage/persistent-volumes/)\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"58\" sourceendlinenumber=\"58\">Persistent Volume Claim</a>. This Claim is an abstraction that requires Kubernetes to set up one persistent volume per each Event Store node and assign an id to it. These volumes are then reused by the cluster, for example, we want to upgrade the version of the Cluster and retain the data. If we donâ€™t specify an existing volume then the volumes are dynamically created.</p>\n<pre sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"60\" sourceendlinenumber=\"64\"><code class=\"lang-shell\">helm repo add eventstore &lt;https://eventstore.github.io/EventStore.Charts&gt;\nhelm repo update\nhelm install -n eventstore eventstore/eventstore --set persistence.enabled=true\n</code></pre><p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"66\" sourceendlinenumber=\"66\">Google Cloud GKE sets the authentication to use RBAC by default. Because of this, to reach your Event Store cluster you have to set up access for  anonymous users. This is something you would only do for a test environment using the following command:</p>\n<pre sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"68\" sourceendlinenumber=\"70\"><code class=\"lang-shell\">kubectl create clusterrolebinding cluster-system-anonymous --clusterrole=cluster-admin --user=system:anonymous\n</code></pre><h2 id=\"upgrade-the-cluster-with-a-newer-version\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"72\" sourceendlinenumber=\"72\">Upgrade the cluster with a newer version</h2>\n<p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"74\" sourceendlinenumber=\"74\">Verify your current Event Store cluster:</p>\n<pre sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"76\" sourceendlinenumber=\"78\"><code class=\"lang-shell\">helm status eventstore\n</code></pre><p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"80\" sourceendlinenumber=\"80\">Fork the official Helm Chart Event Store repository and change the version of the image in the chart <em>values.yaml</em>.</p>\n<p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"82\" sourceendlinenumber=\"82\">And run the command in the same directory as the chart:</p>\n<pre sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"84\" sourceendlinenumber=\"86\"><code class=\"lang-shell\">helm upgrade eventstore . --set persistence.enabled=true\n</code></pre><p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"88\" sourceendlinenumber=\"88\">The upgrade command upgrades all the pods one by one without downtime and attaches the existing volumes to the new pods during the upgrade.</p>\n<h2 id=\"rollback-to-a-previous-version\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"90\" sourceendlinenumber=\"90\">Rollback to a previous version</h2>\n<p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"92\" sourceendlinenumber=\"92\">To rollback the upgrade, first use the following command to display the history:</p>\n<pre sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"94\" sourceendlinenumber=\"96\"><code class=\"lang-shell\">helm history eventstore\n</code></pre><p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"98\" sourceendlinenumber=\"98\">And then the following command to rollback to a specific revision:</p>\n<pre sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"100\" sourceendlinenumber=\"102\"><code class=\"lang-shell\">helm rollback eventstore 1\n</code></pre><h2 id=\"delete-resources\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"104\" sourceendlinenumber=\"104\">Delete resources</h2>\n<pre sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"106\" sourceendlinenumber=\"108\"><code class=\"lang-shell\">gcloud container clusters delete &lt;clustername&gt; --zone &lt;zonename&gt;\n</code></pre><p sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"110\" sourceendlinenumber=\"110\">Then login in to the Google Cloud Web UI, and in the Kubernetes Engine view delete the Kubernetes Cluster using the bin icon.</p>\n","type":"Conceptual","source":{"remote":{"path":"server/deploy-kubernetes-gke.md","branch":"feature/stats-REST","repo":"git@github.com:EventStore/docs.geteventstore.com.git"},"startLine":0.0,"endLine":0.0,"isExternal":false},"path":"server/deploy-kubernetes-gke.md","documentation":{"remote":{"path":"server/deploy-kubernetes-gke.md","branch":"feature/stats-REST","repo":"git@github.com:EventStore/docs.geteventstore.com.git"},"startLine":0.0,"endLine":0.0,"isExternal":false},"_docfxVersion":"2.43.3.0","_disableBreadcrumb":true,"_enableSearch":true,"_gitContribute":{"branch":"master"},"_appFaviconPath":"assets/favicon.ico","_appTitle":"Event Store","_appFooter":"&copy; 2019 Event Store Limited","_disableNavbar":false,"_disableToc":true,"_systemKeys":["conceptual","type","source","path","documentation","title","rawTitle","wordCount"],"title":"Deploy with Kubernetes to Google Cloud GKE","rawTitle":"<h1 id=\"deploy-with-kubernetes-to-google-cloud-gke\" sourcefile=\"server/deploy-kubernetes-gke.md\" sourcestartlinenumber=\"5\" sourceendlinenumber=\"5\">Deploy with Kubernetes to Google Cloud GKE</h1>","outputFileName":"index.html","wordCount":554.0,"_lang":"csharp","_tocPath":"toc.html","_navPath":"toc.html","_rel":"../../","_path":"server/deploy-kubernetes-gke/index.html","_key":"server/deploy-kubernetes-gke.md","_navRel":"../../toc.html","_tocRel":"../../toc.html","_navKey":"~/toc.yml","_tocKey":"~/toc.yml","__global":{"classesInSubtitle":"Classes","structsInSubtitle":"Structs","interfacesInSubtitle":"Interfaces","enumsInSubtitle":"Enums","delegatesInSubtitle":"Delegates","constructorsInSubtitle":"Constructors","fieldsInSubtitle":"Fields","propertiesInSubtitle":"Properties","methodsInSubtitle":"Methods","eventsInSubtitle":"Events","operatorsInSubtitle":"Operators","eiisInSubtitle":"Explicit Interface Implementations","functionsInSubtitle":"Functions","membersInSubtitle":"Members","improveThisDoc":"Improve this Doc","viewSource":"View Source","inheritance":"Inheritance","inheritedMembers":"Inherited Members","namespace":"Namespace","assembly":"Assembly","syntax":"Syntax","overrides":"Overrides","implements":"Implements","remarks":"Remarks","examples":"Examples","seealso":"See Also","declaration":"Declaration","parameters":"Parameters","typeParameters":"Type Parameters","type":"Type","name":"Name","description":"Description","returns":"Returns","fieldValue":"Field Value","propertyValue":"Property Value","eventType":"Event Type","exceptions":"Exceptions","condition":"Condition","extensionMethods":"Extension Methods","note":"<h5>Note</h5>","warning":"<h5>Warning</h5>","tip":"<h5>Tip</h5>","important":"<h5>Important</h5>","caution":"<h5>Caution</h5>","next":"<h5>Next Steps</h5>","_shared":{}},"docurl":"https://github.com/EventStore/docs.geteventstore.com/blob/master/server/deploy-kubernetes-gke.md/#L1"}