{"conceptual":"\n<p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"7\" sourceendlinenumber=\"9\">This guide is to show how to use <a href=\"https://github.com/EventStore/EventStore.Charts\" data-raw-source=\"[the official Event Store Helm Chart](https://github.com/EventStore/EventStore.Charts)\" sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"7\" sourceendlinenumber=\"7\">the official Event Store Helm Chart</a> to\ninteractively deploy an Event Store Cluster in Kubernetes Azure Cloud\nAKS service.</p>\n<h2 id=\"prerequisites\" sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"11\" sourceendlinenumber=\"11\">Prerequisites</h2>\n<p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"13\" sourceendlinenumber=\"13\">Install the following utilities in your development machine.</p>\n<ul sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"15\" sourceendlinenumber=\"17\">\n<li sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"15\" sourceendlinenumber=\"15\"><a href=\"https://kubernetes.io/docs/tasks/tools/install-kubectl\" data-raw-source=\"[Kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl)\" sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"15\" sourceendlinenumber=\"15\">Kubectl</a></li>\n<li sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"16\" sourceendlinenumber=\"16\"><a href=\"https://github.com/helm/helm/releases\" data-raw-source=\"[Helm](https://github.com/helm/helm/releases)\" sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"16\" sourceendlinenumber=\"16\">Helm</a></li>\n<li sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"17\" sourceendlinenumber=\"17\"><a href=\"https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest\" data-raw-source=\"[The Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest)\" sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"17\" sourceendlinenumber=\"17\">The Azure CLI</a></li>\n</ul>\n<h2 id=\"configuration-steps\" sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"19\" sourceendlinenumber=\"19\">Configuration steps</h2>\n<p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"21\" sourceendlinenumber=\"21\">Login in your Azure Cloud account using the az cli, this triggers 2 factor authentication that launches your default browser to select account credentials.</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"23\" sourceendlinenumber=\"25\"><code class=\"lang-shell\">az login\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"27\" sourceendlinenumber=\"27\">Create a new resource group:</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"29\" sourceendlinenumber=\"31\"><code class=\"lang-shell\">az group create -n {resourcegroupname} -l {location-compatible-with-aks}\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"33\" sourceendlinenumber=\"33\">Create a Kubernetes cluster with 3 nodes. This command accept parameters such as the version of Kubernetes you want installed. For this tutorial we use the default options.</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"35\" sourceendlinenumber=\"37\"><code class=\"lang-shell\">az aks create -n {clustername} -g {resourcegroupname} -c 3\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"39\" sourceendlinenumber=\"39\">The command (after some delay) returns a JSON object with details of the new Kubernetes cluster. Use the command below to return a list of all Kubernetes clusters in your Azure account:</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"41\" sourceendlinenumber=\"43\"><code class=\"lang-shell\">az aks list -o table\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"45\" sourceendlinenumber=\"45\">We recommend kubectl for managing resources in the Kubernetes cluster. Set the current context for kubectl and merge it with any existing configuration in your existing config file:</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"47\" sourceendlinenumber=\"49\"><code class=\"lang-shell\">az aks get-credentials -n {clustername} -g {groupname}\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"51\" sourceendlinenumber=\"51\">Get the list of nodes using kubectl:</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"53\" sourceendlinenumber=\"55\"><code class=\"lang-shell\">kubectl get nodes\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"57\" sourceendlinenumber=\"57\">To use the Kubernetes dashboard you need to change the Role Base Access Control enabled by default on Azure AKS.</p>\n<p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"59\" sourceendlinenumber=\"59\">Create a <em>rbac-config.yaml</em> file containing the following yaml:</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"61\" sourceendlinenumber=\"76\"><code class=\"lang-yaml\">apiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: kubernetes-dashboard\n  labels:\n    k8s-app: kubernetes-dashboard\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cluster-admin\nsubjects:\n- kind: ServiceAccount\n  name: kubernetes-dashboard\n  namespace: kube-system\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"78\" sourceendlinenumber=\"78\">Create a deployment for this <code>ClusterRoleBinding</code> object</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"80\" sourceendlinenumber=\"82\"><code class=\"lang-shell\">kubectl create -f ./rbac-config.yaml\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"84\" sourceendlinenumber=\"84\">To access the dashboard you can now use the <code>browse</code> command. This command is a wrapper around the <code>proxy</code> command of kubectl. It creates a local web server with a tunnel to the cluster hosted in Azure AKS web server</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"86\" sourceendlinenumber=\"88\"><code class=\"lang-shell\">az aks browse -n {clustername} -g {groupname}\n</code></pre><h4 id=\"deploy-event-store-cluster-with-helm\" sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"90\" sourceendlinenumber=\"90\">Deploy Event Store Cluster with Helm</h4>\n<p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"92\" sourceendlinenumber=\"92\">Helm is the package manager for Kubernetes. After you&#39;ve created a new Kubernetes cluster you need to configure Helm for your local helm CLI to connect to a configured service account on the server side. The service account used by Helm is called Tiller. Give Tiller access to the cluster and initialise it with the following commands:</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"94\" sourceendlinenumber=\"98\"><code class=\"lang-shell\">kubectl -n kube-system create serviceaccount tiller\nkubectl create clusterrolebinding tiller --clusterrole cluster-admin --serviceaccount=kube-system:tiller\nhelm init --service-account tiller\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"100\" sourceendlinenumber=\"100\">You can then check if the <code>tiller-deploy-xxxx</code> pod is running</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"102\" sourceendlinenumber=\"104\"><code class=\"lang-shell\">kubectl -n kube-system get pod\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"106\" sourceendlinenumber=\"106\">Now deploy the Event Store cluster using the official Helm Chart with the following commands:</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"108\" sourceendlinenumber=\"112\"><code class=\"lang-shell\">helm repo add eventstore https://eventstore.github.io/EventStore.Charts\nhelm repo update\nhelm install -n eventstore eventstore/eventstore --set persistence.enabled=true\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"114\" sourceendlinenumber=\"119\">The Event Store cluster is now deployed and available in a couple of\nminutes. The default cluster size in the Helm Chart is set to 3 so this results in a 3 node Event Store cluster over the 3 nodes Kubernetes\ncluster. The setting <code>persistence.enable=true</code> uses a\n<code>PersistentVolumeClaim</code> on your Kubernetes cluster to claim dynamically\npersistent storage volumes. You can configure this to use\nstatically defined volumes if required.</p>\n<h4 id=\"upgrade-the-event-store-cluster-with-a-newer-version\" sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"121\" sourceendlinenumber=\"121\">Upgrade the Event Store cluster with a newer version</h4>\n<p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"123\" sourceendlinenumber=\"123\">Verify your current Event Store cluster</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"125\" sourceendlinenumber=\"127\"><code class=\"lang-shell\">helm status eventstore\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"129\" sourceendlinenumber=\"130\">Fork the official Helm Chart Event Store repository and change the\nversion of the image in the chart <em>values.yaml</em>.</p>\n<p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"132\" sourceendlinenumber=\"132\">Then run the command in the same directory as the chart:</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"134\" sourceendlinenumber=\"136\"><code class=\"lang-shell\">helm upgrade eventstore . --set persistence.enabled=true\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"138\" sourceendlinenumber=\"140\">The upgrade command silently upgrades all the pods one by one\nwithout downtime. Helm takes care of attaching the existing volumes\nto the new pods during the upgrade.</p>\n<h4 id=\"rollback-to-a-previous-version\" sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"142\" sourceendlinenumber=\"142\">Rollback to a previous version</h4>\n<p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"144\" sourceendlinenumber=\"145\">To rollback to a previous version, first use the following command to\ndisplay the history</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"147\" sourceendlinenumber=\"149\"><code class=\"lang-shell\">helm history eventstore\n</code></pre><p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"151\" sourceendlinenumber=\"151\">And the following command to rollback to a specific revision</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"153\" sourceendlinenumber=\"155\"><code class=\"lang-shell\">helm rollback eventstore 1\n</code></pre><h4 id=\"delete-resources\" sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"157\" sourceendlinenumber=\"157\">Delete resources</h4>\n<p sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"159\" sourceendlinenumber=\"159\">To delete all resources associated with the EventStore installation use the following command:</p>\n<pre sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"161\" sourceendlinenumber=\"164\"><code class=\"lang-shell\">az aks delete -n {clustername} -g {groupname}\naz group delete -n {groupname}\n</code></pre>","type":"Conceptual","source":{"remote":{"path":"server/deploy-kubernetes-aks.md","branch":"feature/stats-REST","repo":"git@github.com:EventStore/docs.geteventstore.com.git"},"startLine":0.0,"endLine":0.0,"isExternal":false},"path":"server/deploy-kubernetes-aks.md","documentation":{"remote":{"path":"server/deploy-kubernetes-aks.md","branch":"feature/stats-REST","repo":"git@github.com:EventStore/docs.geteventstore.com.git"},"startLine":0.0,"endLine":0.0,"isExternal":false},"_docfxVersion":"2.43.3.0","_disableBreadcrumb":true,"_enableSearch":true,"_gitContribute":{"branch":"master"},"_appFaviconPath":"assets/favicon.ico","_appTitle":"Event Store","_appFooter":"&copy; 2019 Event Store Limited","_disableNavbar":false,"_disableToc":true,"_systemKeys":["conceptual","type","source","path","documentation","title","rawTitle","wordCount"],"title":"Deploy with Kubernetes to Azure Cloud AKS","rawTitle":"<h1 id=\"deploy-with-kubernetes-to-azure-cloud-aks\" sourcefile=\"server/deploy-kubernetes-aks.md\" sourcestartlinenumber=\"5\" sourceendlinenumber=\"5\">Deploy with Kubernetes to Azure Cloud AKS</h1>","outputFileName":"index.html","wordCount":650.0,"_lang":"csharp","_tocPath":"toc.html","_navPath":"toc.html","_rel":"../../","_path":"server/deploy-kubernetes-aks/index.html","_key":"server/deploy-kubernetes-aks.md","_navRel":"../../toc.html","_tocRel":"../../toc.html","_navKey":"~/toc.yml","_tocKey":"~/toc.yml","__global":{"classesInSubtitle":"Classes","structsInSubtitle":"Structs","interfacesInSubtitle":"Interfaces","enumsInSubtitle":"Enums","delegatesInSubtitle":"Delegates","constructorsInSubtitle":"Constructors","fieldsInSubtitle":"Fields","propertiesInSubtitle":"Properties","methodsInSubtitle":"Methods","eventsInSubtitle":"Events","operatorsInSubtitle":"Operators","eiisInSubtitle":"Explicit Interface Implementations","functionsInSubtitle":"Functions","membersInSubtitle":"Members","improveThisDoc":"Improve this Doc","viewSource":"View Source","inheritance":"Inheritance","inheritedMembers":"Inherited Members","namespace":"Namespace","assembly":"Assembly","syntax":"Syntax","overrides":"Overrides","implements":"Implements","remarks":"Remarks","examples":"Examples","seealso":"See Also","declaration":"Declaration","parameters":"Parameters","typeParameters":"Type Parameters","type":"Type","name":"Name","description":"Description","returns":"Returns","fieldValue":"Field Value","propertyValue":"Property Value","eventType":"Event Type","exceptions":"Exceptions","condition":"Condition","extensionMethods":"Extension Methods","note":"<h5>Note</h5>","warning":"<h5>Warning</h5>","tip":"<h5>Tip</h5>","important":"<h5>Important</h5>","caution":"<h5>Caution</h5>","next":"<h5>Next Steps</h5>","_shared":{}},"docurl":"https://github.com/EventStore/docs.geteventstore.com/blob/master/server/deploy-kubernetes-aks.md/#L1"}